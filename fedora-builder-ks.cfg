# Fedora 43 Minimal Builder - Podman + SSH only
# Stripped down build host for container image builds

# Use network installation
url --mirrorlist="https://mirrors.fedoraproject.org/mirrorlist?repo=fedora-43&arch=x86_64"

# System language and keyboard
lang en_US.UTF-8
keyboard us
timezone UTC --utc

# Network - DHCP on first interface
network --bootproto=dhcp --device=link --activate --onboot=yes

# Authentication - SSH key + password for Cockpit dashboard
rootpw --iscrypted $6$Bd4hdMwcRKfCTwGa$sSIqDulcHrKIfq9Et/DXUpQON457yKD1e3P.kpsPoApTcdn84pFGOMWpZE1dU69bl5IFH3abVPeiT5KjiEUNN/
sshkey --username=root "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDWUsb0I159v27vSBuOOyQMX54iD2zuKZOOy+e5GRCJ3yONNr3Mkdyng67BNfsnvlf8kpgSi0yiaVGeXKSjkrY9YPHe0wkVW0UHZ9uZqYqgVdEzSG3Z0NNkrd/zp3jCztPad+q6iWb1R0iFlK7/h8NihOky9HXOustrtDwnvTgONwJnluxQp1zl86deKP0W9xx3Ky/Jobr3dbfOhJVK3qzF6OL6KaNjpT+hDYjh1OISzrx1jWLxFvZ4r7X2wbRhcNRyD5sTrxcs3z5Xdz/KRT0UhIj47CF4Heoiqtl/aQ5kdjpRqlmC2spJ9WZinsqbb6HhZ1i8Yd2ZycDQZF+S8n1n gwest@Glenns-MacBook-Pro.local"

# Firewall - SSH + Cockpit
firewall --enabled --ssh --port=9090:tcp
selinux --enforcing

# Disk partitioning - wipe sda, give / the entire disk for container storage
ignoredisk --only-use=sda
clearpart --all --drives=sda --initlabel
part /boot --fstype=xfs --size=1024
part swap --size=4096
part / --fstype=xfs --size=1 --grow

# Bootloader with dual serial console for IPMI SOL (ttyS0=Dell, ttyS1=Supermicro)
bootloader --location=mbr --boot-drive=sda --append="console=tty0 console=ttyS0,115200n8 console=ttyS1,115200n8"

# No GUI
skipx

# Reboot after install
reboot

# Minimal packages - just enough to build containers
%packages --excludedocs
@core
openssh-server
openssh-clients
podman
buildah
skopeo
git
make
curl
tar
gzip
xz
cockpit
cockpit-podman
%end

# Post-install script
%post --log=/root/ks-post.log
# Enable serial console getty for IPMI SOL (both Dell ttyS0 and Supermicro ttyS1)
systemctl enable serial-getty@ttyS0.service
systemctl enable serial-getty@ttyS1.service

# Ensure SSH is enabled
systemctl enable sshd

# Disable unnecessary services
systemctl disable kdump.service 2>/dev/null

# Enable Cockpit web dashboard
systemctl enable cockpit.socket

# Configure GRUB for dual serial console output (IPMI SOL)
# unit=0 for Dell (ttyS0), unit=1 for Supermicro (ttyS1)
# Both get output; last console= in kernel args is primary
cat >> /etc/default/grub <<'GRUBEOF'
GRUB_TERMINAL_OUTPUT="serial console"
GRUB_SERIAL_COMMAND="serial --speed=115200 --unit=0 --word=8 --parity=no --stop=1"
GRUB_CMDLINE_LINUX="$GRUB_CMDLINE_LINUX console=tty0 console=ttyS0,115200n8 console=ttyS1,115200n8"
GRUBEOF
grub2-mkconfig -o /boot/grub2/grub.cfg

# Configure podman for rootless builds (also works as root)
echo "net.ipv4.ping_group_range = 0 2147483647" > /etc/sysctl.d/podman.conf

# Clean up
dnf clean all
rm -rf /var/cache/dnf
%end
