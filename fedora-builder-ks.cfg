# Fedora 43 Minimal Builder - Podman + SSH only
# Stripped down build host for container image builds

# Use network installation
url --mirrorlist="https://mirrors.fedoraproject.org/mirrorlist?repo=fedora-43&arch=x86_64"

# System language and keyboard
lang en_US.UTF-8
keyboard us
timezone UTC --utc

# Network - DHCP on first interface
network --bootproto=dhcp --device=link --activate --onboot=yes

# Authentication - SSH key only, no root password
rootpw --lock
sshkey --username=root "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDWUsb0I159v27vSBuOOyQMX54iD2zuKZOOy+e5GRCJ3yONNr3Mkdyng67BNfsnvlf8kpgSi0yiaVGeXKSjkrY9YPHe0wkVW0UHZ9uZqYqgVdEzSG3Z0NNkrd/zp3jCztPad+q6iWb1R0iFlK7/h8NihOky9HXOustrtDwnvTgONwJnluxQp1zl86deKP0W9xx3Ky/Jobr3dbfOhJVK3qzF6OL6KaNjpT+hDYjh1OISzrx1jWLxFvZ4r7X2wbRhcNRyD5sTrxcs3z5Xdz/KRT0UhIj47CF4Heoiqtl/aQ5kdjpRqlmC2spJ9WZinsqbb6HhZ1i8Yd2ZycDQZF+S8n1n gwest@Glenns-MacBook-Pro.local"

# Firewall - SSH + Cockpit
firewall --enabled --ssh --port=9090:tcp
selinux --enforcing

# Disk partitioning - wipe sda, use plain partitions (no LVM overhead)
ignoredisk --only-use=sda
clearpart --all --drives=sda --initlabel
autopart --type=plain --nohome

# Bootloader with serial console for IPMI SOL
bootloader --location=mbr --boot-drive=sda --append="console=tty0 console=ttyS1,115200n8"

# No GUI
skipx

# Reboot after install
reboot

# Minimal packages - just enough to build containers
%packages --excludedocs
@core
openssh-server
openssh-clients
podman
buildah
skopeo
git
make
curl
tar
gzip
xz
cockpit
cockpit-podman
%end

# Post-install script
%post --log=/root/ks-post.log
# Enable serial console getty for IPMI SOL
systemctl enable serial-getty@ttyS1.service

# Ensure SSH is enabled
systemctl enable sshd

# Disable unnecessary services
systemctl disable kdump.service 2>/dev/null

# Enable Cockpit web dashboard
systemctl enable cockpit.socket

# Configure GRUB for serial console output (IPMI SOL)
cat >> /etc/default/grub <<'GRUBEOF'
GRUB_TERMINAL_OUTPUT="serial console"
GRUB_SERIAL_COMMAND="serial --speed=115200 --unit=1 --word=8 --parity=no --stop=1"
GRUBEOF
grub2-mkconfig -o /boot/grub2/grub.cfg

# Configure podman for rootless builds (also works as root)
echo "net.ipv4.ping_group_range = 0 2147483647" > /etc/sysctl.d/podman.conf

# Clean up
dnf clean all
rm -rf /var/cache/dnf
%end
