# Fedora CoreOS Builder - Butane config
# Convert to Ignition JSON: butane --strict builder.bu > builder.ign
# Purpose: Container build host with podman, dual serial console (Dell ttyS0 + Supermicro ttyS1)
variant: fcos
version: "1.5.0"

passwd:
  users:
    - name: root
      password_hash: "$6$Bd4hdMwcRKfCTwGa$sSIqDulcHrKIfq9Et/DXUpQON457yKD1e3P.kpsPoApTcdn84pFGOMWpZE1dU69bl5IFH3abVPeiT5KjiEUNN/"
      ssh_authorized_keys:
        - "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDWUsb0I159v27vSBuOOyQMX54iD2zuKZOOy+e5GRCJ3yONNr3Mkdyng67BNfsnvlf8kpgSi0yiaVGeXKSjkrY9YPHe0wkVW0UHZ9uZqYqgVdEzSG3Z0NNkrd/zp3jCztPad+q6iWb1R0iFlK7/h8NihOky9HXOustrtDwnvTgONwJnluxQp1zl86deKP0W9xx3Ky/Jobr3dbfOhJVK3qzF6OL6KaNjpT+hDYjh1OISzrx1jWLxFvZ4r7X2wbRhcNRyD5sTrxcs3z5Xdz/KRT0UhIj47CF4Heoiqtl/aQ5kdjpRqlmC2spJ9WZinsqbb6HhZ1i8Yd2ZycDQZF+S8n1n gwest@Glenns-MacBook-Pro.local"
    - name: core
      password_hash: "$6$Bd4hdMwcRKfCTwGa$sSIqDulcHrKIfq9Et/DXUpQON457yKD1e3P.kpsPoApTcdn84pFGOMWpZE1dU69bl5IFH3abVPeiT5KjiEUNN/"
      ssh_authorized_keys:
        - "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDWUsb0I159v27vSBuOOyQMX54iD2zuKZOOy+e5GRCJ3yONNr3Mkdyng67BNfsnvlf8kpgSi0yiaVGeXKSjkrY9YPHe0wkVW0UHZ9uZqYqgVdEzSG3Z0NNkrd/zp3jCztPad+q6iWb1R0iFlK7/h8NihOky9HXOustrtDwnvTgONwJnluxQp1zl86deKP0W9xx3Ky/Jobr3dbfOhJVK3qzF6OL6KaNjpT+hDYjh1OISzrx1jWLxFvZ4r7X2wbRhcNRyD5sTrxcs3z5Xdz/KRT0UhIj47CF4Heoiqtl/aQ5kdjpRqlmC2spJ9WZinsqbb6HhZ1i8Yd2ZycDQZF+S8n1n gwest@Glenns-MacBook-Pro.local"
      groups:
        - wheel

kernel_arguments:
  should_exist:
    - console=tty0
    - console=ttyS0,115200n8
    - console=ttyS1,115200n8

systemd:
  units:
    - name: serial-getty@ttyS0.service
      enabled: true
    - name: serial-getty@ttyS1.service
      enabled: true
    - name: podman.socket
      enabled: true
    - name: podman-tcp.socket
      enabled: true
      contents: |
        [Unit]
        Description=Podman API TCP Socket

        [Socket]
        ListenStream=2375
        Accept=no

        [Install]
        WantedBy=sockets.target
    - name: podman-tcp.service
      enabled: false
      contents: |
        [Unit]
        Description=Podman API TCP Service
        Requires=podman-tcp.socket
        After=podman-tcp.socket
        BindsTo=podman-tcp.socket

        [Service]
        Type=exec
        ExecStart=/usr/bin/podman system service --time=0 tcp://0.0.0.0:2375
        KillMode=process
        Restart=on-failure

        [Install]
        WantedBy=default.target
    - name: rpm-ostree-install.service
      enabled: true
      contents: |
        [Unit]
        Description=Layer buildah, skopeo, and cockpit on first boot
        After=network-online.target
        Wants=network-online.target
        ConditionPathExists=!/var/lib/%N.stamp

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/bin/rpm-ostree install --idempotent --allow-inactive buildah skopeo cockpit cockpit-podman
        ExecStart=/bin/touch /var/lib/%N.stamp
        ExecStart=/usr/bin/systemctl reboot

        [Install]
        WantedBy=multi-user.target
    - name: cockpit.socket
      enabled: true

storage:
  files:
    - path: /etc/profile.d/builder.sh
      mode: 0644
      contents:
        inline: |
          alias docker=podman
          export CONTAINER_HOST=tcp://localhost:2375
    - path: /etc/firewalld/zones/public.xml
      mode: 0644
      contents:
        inline: |
          <?xml version="1.0" encoding="utf-8"?>
          <zone>
            <short>Public</short>
            <service name="ssh"/>
            <service name="dhcpv6-client"/>
            <service name="cockpit"/>
            <port protocol="tcp" port="9090"/>
            <port protocol="tcp" port="2375"/>
          </zone>
