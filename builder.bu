# Fedora CoreOS Builder - Butane config
# Convert to Ignition JSON: butane --strict builder.bu > builder.ign
# Purpose: Container build host with podman, dual serial console (Dell ttyS0 + Supermicro ttyS1)
variant: fcos
version: "1.5.0"

passwd:
  users:
    - name: root
      password_hash: "$6$Bd4hdMwcRKfCTwGa$sSIqDulcHrKIfq9Et/DXUpQON457yKD1e3P.kpsPoApTcdn84pFGOMWpZE1dU69bl5IFH3abVPeiT5KjiEUNN/"
      ssh_authorized_keys:
        - "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDWUsb0I159v27vSBuOOyQMX54iD2zuKZOOy+e5GRCJ3yONNr3Mkdyng67BNfsnvlf8kpgSi0yiaVGeXKSjkrY9YPHe0wkVW0UHZ9uZqYqgVdEzSG3Z0NNkrd/zp3jCztPad+q6iWb1R0iFlK7/h8NihOky9HXOustrtDwnvTgONwJnluxQp1zl86deKP0W9xx3Ky/Jobr3dbfOhJVK3qzF6OL6KaNjpT+hDYjh1OISzrx1jWLxFvZ4r7X2wbRhcNRyD5sTrxcs3z5Xdz/KRT0UhIj47CF4Heoiqtl/aQ5kdjpRqlmC2spJ9WZinsqbb6HhZ1i8Yd2ZycDQZF+S8n1n gwest@Glenns-MacBook-Pro.local"

kernel_arguments:
  should_exist:
    - console=tty0
    - console=ttyS0,115200n8
    - console=ttyS1,115200n8

systemd:
  units:
    - name: serial-getty@ttyS0.service
      enabled: true
    - name: serial-getty@ttyS1.service
      enabled: true
    - name: podman.socket
      enabled: true
    - name: rpm-ostree-install.service
      enabled: true
      contents: |
        [Unit]
        Description=Layer buildah, skopeo, and cockpit on first boot
        After=network-online.target
        Wants=network-online.target
        ConditionPathExists=!/var/lib/%N.stamp

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/bin/rpm-ostree install --idempotent --allow-inactive buildah skopeo cockpit cockpit-podman
        ExecStart=/bin/touch /var/lib/%N.stamp
        ExecStart=/usr/bin/systemctl reboot

        [Install]
        WantedBy=multi-user.target
    - name: cockpit.socket
      enabled: true

storage:
  files:
    - path: /etc/profile.d/builder.sh
      mode: 0644
      contents:
        inline: |
          alias docker=podman
